<!DOCTYPE html>
<html>
<head>
    <title>爱购 - shop</title>
    <style>
        /* 原有基础样式保留 */
       .search-input {
            width: 100%;
            height: 44px;
            padding-left: 44px;
            border: 2px solid #999;
            border-radius: 22px;
            outline: none;
            font-size: 16px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"><path d="M16.32 14.9l5.39 5.4a1 1 0 0 1-1.42 1.4l-5.38-5.38a8 8 0 1 1 1.41-1.41zM10 16a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/></svg>') no-repeat 16px center;
            background-size: 20px;
            box-sizing: border-box;
            margin: 10px 0;
        }
       .search-input::placeholder {
            color: #999;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: #fff;
        }
        th,
        td {
            border: 1px solid #ccc;
            padding: 12px 8px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: 600;
            /* 为筛选菜单预留定位空间 */
            position: relative;
            cursor: pointer; /* 提示可点击筛选 */
        }
        /* 筛选相关样式：下拉菜单 + 图标 */
       .filter-icon {
            margin-left: 5px;
            color: #666;
            font-size: 14px;
        }
       .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 100px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            list-style: none;
            padding: 5px 0;
            margin: 0;
            display: none; /* 默认隐藏 */
            z-index: 200; /* 确保在表格上方 */
        }
       .filter-dropdown li {
            padding: 6px 12px;
            cursor: pointer;
        }
       .filter-dropdown li:hover {
            background-color: #f0f0f0;
        }
       .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            z-index: 999;
        }
       .quantity-btn {
            padding: 10px 20px;
            font-size: 16px;
            margin: 0 10px;
            background-color: #8b4513;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
       .close-btn,.add-btn {
            padding: 10px 20px;
            margin-top: 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
       .close-btn {
            background: #f4f4f4;
            border: 1px solid #ccc;
            margin-right: 10px;
        }
       .add-btn {
            background: #8b4513;
            color: white;
            border: none;
        }
        /* 底部按钮样式保留 */
       .bottom-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: #fff;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 0 20px;
            z-index: 100;
        }
       .bottom-button {
            padding: 10px 20px;
            background-color: #8b4513;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
       .bottom-button:hover {
            background-color: #6d380e;
        }
       .added-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 999;
        }
       .copied-toast {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 999;
        }
       .load-error {
            text-align: center;
            padding: 50px 0;
            color: #ff4444;
            font-size: 16px;
        }
        /* 基础样式重置保留 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            margin-top: 60px;
            margin-bottom: 70px;
            padding: 20px;
            min-height: 2000px;
        }
       .search-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            padding: 0 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- 顶部搜索栏保留 -->
    <div class="search-bar">
        <input type="search" class="search-input" placeholder="请输入商品名称，未列产品可微信咨询" 
               oninput="filterTable()" onkeydown="handleKeyDown(event)">
    </div>

    <!-- 商品表格：新增「说明」列 + 筛选下拉 -->
    <table>
        <thead>
            <tr>
                <th>时间</th>
                <th>商品名</th>
                <!-- 新增「说明」列，带筛选功能 -->
                <th onclick="toggleFilterDropdown()">
                    说明
                    <span class="filter-icon">▼</span>
                    <!-- 筛选下拉菜单 -->
                    <ul class="filter-dropdown" id="descFilterDropdown">
                        <li onclick="filterByDescription('全部')">全部</li>
                        <li onclick="filterByDescription('特价')">特价</li>
                        <li onclick="filterByDescription('新品')">新品</li>
                        <li onclick="filterByDescription('折损')">折损</li>
                    </ul>
                </th>
                <th>价格</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- 商品行从new.json动态加载 -->
        </tbody>
    </table>

    <!-- 数据加载失败提示保留 -->
    <div class="load-error" id="loadError" style="display: none;">
        商品数据加载失败，请检查new.json文件是否存在且格式正确！
    </div>

    <!-- 加购弹窗保留 -->
    <div class="popup" id="myPopup">
        <div class="popup-content">
            <h2>添加购物清单</h2>
            <p id="popupProductInfo"></p>
            <button class="quantity-btn" onclick="decrementQuantity()">-</button>
            <input type="number" id="quantity" value="1" min="1" style="width: 50px; text-align: center;">
            <button class="quantity-btn" onclick="incrementQuantity()">+</button>
            <br>
            <button class="close-btn" onclick="closePopup()">取消</button>
            <button class="add-btn" onclick="addToCart()">加入清单</button>
        </div>
    </div>

    <!-- 提示组件保留 -->
    <div class="added-toast" id="addedToast">已加购</div>
    <div class="copied-toast" id="copiedToast">微信复制成功</div>

    <!-- 底部按钮保留 -->
    <div class="bottom-buttons">
        <button class="bottom-button" onclick="goToHome()">首页</button>
        <button class="bottom-button" onclick="goToSpecial()">特价/新品</button>
        <button class="bottom-button" onclick="goToCart()">购物清单</button>
        <button class="bottom-button" onclick="copyWechat()">复制微信</button>
    </div>

    <script>
        const tableBody = document.getElementById('tableBody');
        const loadError = document.getElementById('loadError');
        let currentProduct = null;
        let currentQuantity = 1;
        let currentDescFilter = '全部'; // 全局筛选状态：默认“全部”

        // 1. 加载new.json数据（新增「说明」列处理）
        fetch('new.json')
           .then(response => {
                if (!response.ok) throw new Error(`文件访问失败，状态码：${response.status}`);
                return response.json();
            })
           .then(products => {
                if (!Array.isArray(products)) throw new Error('new.json需为数组格式');
                
                // 动态生成表格行（新增「说明」列单元格）
                products.forEach(product => {
                    if (!product.商品名 || product.价格 === undefined) {
                        console.warn('跳过无效商品（缺少商品名/价格）：', product);
                        return;
                    }
                    const row = document.createElement('tr');
                    // 时间列
                    const timeCell = document.createElement('td');
                    timeCell.textContent = new Date().toLocaleString();
                    // 商品名列
                    const nameCell = document.createElement('td');
                    nameCell.textContent = product.商品名;
                    // 新增：说明列（从json取“说明”字段，无则显示“无”）
                    const descCell = document.createElement('td');
                    descCell.textContent = product.说明 || '无'; // 兼容无说明的商品
                    // 价格列
                    const priceCell = document.createElement('td');
                    priceCell.textContent = `¥${Number(product.价格).toFixed(2)}`;
                    // 操作列
                    const actionCell = document.createElement('td');
                    const addBtn = document.createElement('button');
                    addBtn.textContent = '加购';
                    addBtn.style.cssText = 'padding:5px 10px;background:#8b4513;color:white;border:none;border-radius:3px;cursor:pointer';
                    addBtn.onclick = () => {
                        currentProduct = product;
                        // 弹窗信息新增「说明」显示
                        const descText = product.说明 || '无';
                        document.getElementById('popupProductInfo').textContent = 
                            `${product.商品名}（${descText}） ¥${Number(product.价格).toFixed(2)}`;
                        currentQuantity = 1;
                        document.getElementById('quantity').value = currentQuantity;
                        document.getElementById('myPopup').style.display = 'block';
                    };
                    actionCell.appendChild(addBtn);

                    // 组装行（顺序：时间→商品名→说明→价格→操作）
                    row.appendChild(timeCell);
                    row.appendChild(nameCell);
                    row.appendChild(descCell);
                    row.appendChild(priceCell);
                    row.appendChild(actionCell);
                    tableBody.appendChild(row);
                });

                // 初始加载后执行一次筛选（确保默认“全部”状态正常）
                filterTable();
            })
           .catch(error => {
                loadError.style.display = 'block';
                console.error('数据加载失败：', error);
            });

        // 2. 原有搜索功能（升级：兼容「说明」筛选）
        function filterTable() {
            const searchInput = document.querySelector('.search-input').value.trim().toUpperCase();
            const rows = tableBody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const nameCell = rows[i].getElementsByTagName('td')[1]; // 商品名（索引1）
                const descCell = rows[i].getElementsByTagName('td')[2]; // 说明（索引2）
                const nameMatch = nameCell.textContent.toUpperCase().includes(searchInput);
                const descMatch = currentDescFilter === '全部' 
                    ? true 
                    : descCell.textContent === currentDescFilter;

                // 同时满足“搜索匹配”和“筛选匹配”才显示
                rows[i].style.display = (nameMatch && descMatch)? '' : 'none';
            }
        }

        // 3. 新增：「说明」列筛选功能
        // 切换筛选下拉菜单显示/隐藏
        function toggleFilterDropdown() {
            const dropdown = document.getElementById('descFilterDropdown');
            dropdown.style.display = dropdown.style.display === 'block'? 'none' : 'block';
        }
        // 执行筛选（更新筛选状态并触发过滤）
        function filterByDescription(desc) {
            currentDescFilter = desc;
            filterTable(); // 筛选后立即更新表格
            toggleFilterDropdown(); // 关闭下拉菜单
        }

        // 4. 点击页面其他区域关闭筛选下拉
        window.onclick = function(event) {
            const popup = document.getElementById('myPopup');
            const dropdown = document.getElementById('descFilterDropdown');
            // 关闭加购弹窗
            if (event.target === popup) closePopup();
            // 关闭筛选下拉（点击非下拉区域）
            if (!event.target.closest('th') && dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            }
        }

        // 5. 原有功能保留（回车搜索、数量增减、加购、导航等）
        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                filterTable();
                event.preventDefault();
            }
        }
        function incrementQuantity() {
            currentQuantity++;
            document.getElementById('quantity').value = currentQuantity;
        }
        function decrementQuantity() {
            if (currentQuantity > 1) {
                currentQuantity--;
                document.getElementById('quantity').value = currentQuantity;
            }
        }
        function closePopup() {
            document.getElementById('myPopup').style.display = 'none';
        }
        function addToCart() {
            if (!currentProduct) return;
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const existingItemIndex = cart.findIndex(item => item.name === currentProduct.商品名);
            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity += currentQuantity;
            } else {
                cart.push({
                    name: currentProduct.商品名,
                    desc: currentProduct.说明 || '无', // 购物车保留说明
                    price: Number(currentProduct.价格),
                    quantity: currentQuantity,
                    time: new Date().toLocaleString()
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            const toast = document.getElementById('addedToast');
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2000);
            closePopup();
        }
        function goToHome() {
            window.location.href = "index.html";
        }
        function goToSpecial() {
            window.location.href = "shop.html"; // 需手动创建special.html
        }
        function goToCart() {
            window.location.href = "cart.html";
        }
        function copyWechat() {
            const wechatNumber ='meiliaigou4';
            navigator.clipboard.writeText(wechatNumber)
               .then(() => {
                    const toast = document.getElementById('copiedToast');
                    toast.style.display = 'block';
                    setTimeout(() => toast.style.display = 'none', 5000);
                })
               .catch(err => {
                    alert('复制失败，请手动复制：' + wechatNumber);
                    console.error('复制错误：', err);
                });
        }
    </script>
</body>
</html>